{% extends "base.html" %}

{% block content %}
<div class="learn-page">
  <div class="learn-container">
    <!-- Sidebar with course navigation -->
    <aside class="learn-sidebar">
      <div class="sidebar-header">
        <a href="{{ url_for('courses.my_courses') }}" class="back-link">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
            <path d="M15 10H5M10 5l-5 5 5 5" stroke="currentColor" stroke-width="2"/>
          </svg>
          –ú–æ–∏ –∫—É—Ä—Å—ã
        </a>
        <h2 class="course-title">{{ course.title }}</h2>

        <!-- Progress bar -->
        <div class="progress-wrapper">
          <div class="progress-bar">
            <div class="progress-fill" style="width: {{ progress_percent }}%"></div>
          </div>
          <div class="progress-text">
            {{ completed_lessons }} –∏–∑ {{ total_lessons }} —É—Ä–æ–∫–æ–≤
          </div>
        </div>
      </div>

      <!-- Modules and lessons list -->
      <div class="modules-list">
        {% for module in modules %}
        <div class="module-item">
          <h3 class="module-title">{{ module.title }}</h3>
          <ul class="lessons-list">
            {% for lesson in module.lessons|sort(attribute='order') %}
            <li class="lesson-item {% if current_lesson and lesson.id == current_lesson.id %}active{% endif %}
                                   {% if progress_map.get(lesson.id) and progress_map[lesson.id].status == 'completed' %}completed{% endif %}">
              <a href="{{ url_for('courses.view_lesson', slug=course.slug, lesson_id=lesson.id) }}">
                <span class="lesson-status">
                  {% if progress_map.get(lesson.id) and progress_map[lesson.id].status == 'completed' %}
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                      <path d="M6 11.5L2 7.5l1.4-1.4L6 8.7l6.6-6.6L14 3.5z"/>
                    </svg>
                  {% elif progress_map.get(lesson.id) and progress_map[lesson.id].status == 'in_progress' %}
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                      <circle cx="8" cy="8" r="3"/>
                    </svg>
                  {% else %}
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor">
                      <circle cx="8" cy="8" r="6" stroke-width="2"/>
                    </svg>
                  {% endif %}
                </span>
                <span class="lesson-name">{{ lesson.title }}</span>
                <span class="lesson-duration">{{ lesson.estimated_time_minutes }} –º–∏–Ω</span>
              </a>
            </li>
            {% endfor %}
          </ul>
        </div>
        {% endfor %}
      </div>
    </aside>

    <!-- Main content area -->
    <main class="learn-content">
      {% if current_lesson %}
      <div class="lesson-container">
        <!-- Lesson header -->
        <div class="lesson-header">
          <h1 class="lesson-title">{{ current_lesson.title }}</h1>
          <div class="lesson-meta">
            <span class="lesson-time">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M8 1C4.1 1 1 4.1 1 8s3.1 7 7 7 7-3.1 7-7-3.1-7-7-7zm0 12.5c-3 0-5.5-2.5-5.5-5.5S5 2.5 8 2.5s5.5 2.5 5.5 5.5-2.5 5.5-5.5 5.5z"/>
                <path d="M8 4v4.5l3.5 2.1-.7 1.2L7 9V4h1z"/>
              </svg>
              {{ current_lesson.estimated_time_minutes }} –º–∏–Ω—É—Ç
            </span>
            {% if lesson_progress %}
            <span class="lesson-status-badge status-{{ lesson_progress.status }}">
              {% if lesson_progress.status == 'completed' %}
                ‚úì –ó–∞–≤–µ—Ä—à—ë–Ω
              {% elif lesson_progress.status == 'in_progress' %}
                ‚è≥ –í –ø—Ä–æ—Ü–µ—Å—Å–µ
              {% else %}
                ‚óã –ù–µ –Ω–∞—á–∞—Ç
              {% endif %}
            </span>
            {% endif %}
          </div>
        </div>

        <!-- Lesson content (Markdown) -->
        <div class="lesson-body markdown-content">
          {{ current_lesson.content_text | safe if current_lesson.content_text else '–ö–æ–Ω—Ç–µ–Ω—Ç —É—Ä–æ–∫–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...' }}
        </div>

        <!-- Quiz section -->
        {% if current_lesson.quiz_questions and current_lesson.quiz_questions.questions %}
        <div class="lesson-quiz" id="lesson-quiz">
          <h2 class="quiz-title">üìù –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–≤–æ–∏ –∑–Ω–∞–Ω–∏—è</h2>
          <p class="quiz-description">–û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã, —á—Ç–æ–±—ã –∑–∞–∫—Ä–µ–ø–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª —É—Ä–æ–∫–∞.</p>

          <form id="quiz-form" class="quiz-form">
            {% for question in current_lesson.quiz_questions.questions %}
            <div class="quiz-question" data-question-idx="{{ loop.index0 }}">
              <h3 class="question-text">{{ loop.index }}. {{ question.question }}</h3>
              <div class="question-answers">
                {% for answer in question.answers %}
                <label class="answer-option">
                  <input type="radio" name="question-{{ loop.index0 }}" value="{{ loop.index0 }}" required>
                  <span class="answer-text">{{ answer }}</span>
                  <span class="answer-indicator"></span>
                </label>
                {% endfor %}
              </div>
              <div class="question-feedback" style="display: none;"></div>
            </div>
            {% endfor %}

            <div class="quiz-actions">
              <button type="submit" class="btn btn--primary btn--large">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç—ã</button>
            </div>
          </form>

          <div class="quiz-results" id="quiz-results" style="display: none;">
            <div class="results-header">
              <h3 class="results-title">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h3>
              <div class="results-score">
                <span class="score-value"></span>
              </div>
            </div>
            <div class="results-message"></div>
            <button class="btn btn--ghost" onclick="location.reload()">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
          </div>
        </div>
        {% endif %}

        <!-- Lesson actions -->
        <div class="lesson-actions">
          {% if lesson_progress and lesson_progress.status != 'completed' %}
          <button id="complete-btn" class="btn btn--success btn--large" onclick="markAsComplete()">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
              <path d="M7 14L2 9l1.4-1.4L7 11.2l9.6-9.6L18 3z"/>
            </svg>
            –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–π
          </button>
          {% endif %}

          {% if next_lesson %}
          <a href="{{ url_for('courses.view_lesson', slug=course.slug, lesson_id=next_lesson.id) }}"
             class="btn btn--primary btn--large">
            –°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–∫
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
              <path d="M5 10h10M10 5l5 5-5 5" stroke="currentColor" stroke-width="2"/>
            </svg>
          </a>
          {% else %}
          <div class="completion-message">
            <h3>üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</h3>
            <p>–í—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏ –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —É—Ä–æ–∫–∏ —ç—Ç–æ–≥–æ –∫—É—Ä—Å–∞.</p>
          </div>
          {% endif %}
        </div>
      </div>
      {% else %}
      <!-- No lesson selected (shouldn't happen with redirect) -->
      <div class="no-lesson">
        <p>–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–∫ –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞.</p>
      </div>
      {% endif %}
    </main>
  </div>
</div>

<script>
// Mark lesson as complete
async function markAsComplete() {
  const btn = document.getElementById('complete-btn');
  btn.disabled = true;
  btn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

  try {
    const response = await fetch('{{ url_for("courses.complete_lesson", slug=course.slug, lesson_id=current_lesson.id) }}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });

    if (response.ok) {
      btn.textContent = '‚úì –ó–∞–≤–µ—Ä—à–µ–Ω–æ!';
      btn.classList.remove('btn--success');
      btn.classList.add('btn--ghost');

      // Reload page to update progress
      setTimeout(() => location.reload(), 1000);
    }
  } catch (error) {
    console.error('Error marking lesson complete:', error);
    btn.disabled = false;
    btn.textContent = '–û—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞';
  }
}

// Quiz submission
{% if current_lesson and current_lesson.quiz_questions %}
document.getElementById('quiz-form')?.addEventListener('submit', async (e) => {
  e.preventDefault();

  // Collect answers
  const answers = [];
  const questions = document.querySelectorAll('.quiz-question');
  questions.forEach((q, idx) => {
    const selected = q.querySelector('input[type="radio"]:checked');
    answers.push(selected ? parseInt(selected.value) : -1);
  });

  try {
    const response = await fetch('{{ url_for("courses.submit_quiz", slug=course.slug, lesson_id=current_lesson.id) }}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ answers })
    });

    const result = await response.json();

    if (result.success) {
      // Show feedback for each question
      result.results.forEach((r, idx) => {
        const questionEl = questions[idx];
        const feedbackEl = questionEl.querySelector('.question-feedback');
        const answerOptions = questionEl.querySelectorAll('.answer-option');

        // Mark correct/incorrect
        answerOptions.forEach((opt, optIdx) => {
          if (optIdx === r.correct_answer) {
            opt.classList.add('correct');
          }
          if (optIdx === answers[idx] && !r.correct) {
            opt.classList.add('incorrect');
          }
        });

        // Show explanation
        feedbackEl.style.display = 'block';
        feedbackEl.innerHTML = `<p>${r.correct ? '‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ!' : '‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ.'} ${r.explanation}</p>`;
      });

      // Show results summary
      document.getElementById('quiz-form').style.display = 'none';
      const resultsEl = document.getElementById('quiz-results');
      resultsEl.style.display = 'block';
      resultsEl.querySelector('.score-value').textContent = `${result.score}%`;

      const message = result.passed
        ? `üéâ –û—Ç–ª–∏—á–Ω–æ! –í—ã –Ω–∞–±—Ä–∞–ª–∏ ${result.correct_count} –∏–∑ ${result.total_questions} –±–∞–ª–ª–æ–≤.`
        : `–í—ã –Ω–∞–±—Ä–∞–ª–∏ ${result.correct_count} –∏–∑ ${result.total_questions} –±–∞–ª–ª–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑!`;
      resultsEl.querySelector('.results-message').textContent = message;

      // Auto-complete if passed
      if (result.passed) {
        setTimeout(() => location.reload(), 3000);
      }
    }
  } catch (error) {
    console.error('Error submitting quiz:', error);
    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–≤–µ—Ç–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
  }
});
{% endif %}
</script>

<style>
.learn-page {
  min-height: 100vh;
  background: var(--dark-bg);
  padding-top: 80px;
}

.learn-container {
  display: flex;
  max-width: 1600px;
  margin: 0 auto;
  gap: 0;
}

/* Sidebar */
.learn-sidebar {
  width: 360px;
  background: rgba(20, 20, 30, 0.8);
  border-right: 1px solid rgba(139, 92, 246, 0.2);
  padding: 2rem;
  height: calc(100vh - 80px);
  overflow-y: auto;
  position: sticky;
  top: 80px;
}

.sidebar-header {
  margin-bottom: 2rem;
}

.back-link {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  color: var(--text-secondary);
  text-decoration: none;
  font-size: 0.9rem;
  margin-bottom: 1rem;
  transition: color 0.3s;
}

.back-link:hover {
  color: var(--primary);
}

.course-title {
  font-size: 1.25rem;
  margin-bottom: 1.5rem;
  color: var(--text);
}

.progress-wrapper {
  margin-top: 1rem;
}

.progress-bar {
  height: 8px;
  background: rgba(139, 92, 246, 0.2);
  border-radius: 8px;
  overflow: hidden;
  margin-bottom: 0.5rem;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--primary), var(--accent));
  transition: width 0.5s ease;
}

.progress-text {
  font-size: 0.85rem;
  color: var(--text-secondary);
  text-align: center;
}

/* Modules list */
.modules-list {
  margin-top: 2rem;
}

.module-item {
  margin-bottom: 2rem;
}

.module-title {
  font-size: 1rem;
  margin-bottom: 0.75rem;
  color: var(--primary);
  font-weight: 600;
}

.lessons-list {
  list-style: none;
  padding: 0;
}

.lesson-item {
  margin-bottom: 0.5rem;
}

.lesson-item a {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.75rem;
  background: rgba(139, 92, 246, 0.05);
  border-radius: 8px;
  text-decoration: none;
  color: var(--text-secondary);
  transition: all 0.3s;
  border: 1px solid transparent;
}

.lesson-item a:hover {
  background: rgba(139, 92, 246, 0.1);
  border-color: var(--primary);
}

.lesson-item.active a {
  background: rgba(139, 92, 246, 0.2);
  border-color: var(--primary);
  color: var(--text);
}

.lesson-item.completed a {
  color: var(--success);
}

.lesson-status svg {
  width: 16px;
  height: 16px;
  flex-shrink: 0;
}

.lesson-name {
  flex: 1;
  font-size: 0.9rem;
}

.lesson-duration {
  font-size: 0.75rem;
  color: var(--text-secondary);
  opacity: 0.7;
}

/* Main content */
.learn-content {
  flex: 1;
  padding: 3rem;
  max-width: 900px;
}

.lesson-header {
  margin-bottom: 2rem;
}

.lesson-title {
  font-size: 2.5rem;
  margin-bottom: 1rem;
  background: linear-gradient(135deg, var(--primary), var(--accent));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.lesson-meta {
  display: flex;
  align-items: center;
  gap: 1rem;
  color: var(--text-secondary);
  font-size: 0.9rem;
}

.lesson-time {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.lesson-status-badge {
  padding: 0.25rem 0.75rem;
  border-radius: 12px;
  font-size: 0.85rem;
  font-weight: 500;
}

.status-completed {
  background: rgba(16, 185, 129, 0.2);
  color: var(--success);
}

.status-in_progress {
  background: rgba(245, 158, 11, 0.2);
  color: var(--warning);
}

/* Lesson body - Markdown content */
.lesson-body {
  margin-bottom: 3rem;
  line-height: 1.8;
  color: var(--text);
}

.markdown-content h1,
.markdown-content h2,
.markdown-content h3 {
  margin-top: 2rem;
  margin-bottom: 1rem;
  color: var(--text);
}

.markdown-content h2 {
  font-size: 1.75rem;
  border-bottom: 2px solid rgba(139, 92, 246, 0.3);
  padding-bottom: 0.5rem;
}

.markdown-content p {
  margin-bottom: 1rem;
}

.markdown-content ul,
.markdown-content ol {
  margin-bottom: 1rem;
  padding-left: 2rem;
}

.markdown-content li {
  margin-bottom: 0.5rem;
}

.markdown-content code {
  background: rgba(139, 92, 246, 0.1);
  padding: 0.2rem 0.4rem;
  border-radius: 4px;
  font-family: 'Fira Code', monospace;
  font-size: 0.9em;
}

/* Quiz section */
.lesson-quiz {
  background: rgba(20, 20, 30, 0.6);
  border: 1px solid rgba(139, 92, 246, 0.2);
  border-radius: 12px;
  padding: 2rem;
  margin-bottom: 2rem;
}

.quiz-title {
  font-size: 1.5rem;
  margin-bottom: 0.5rem;
}

.quiz-description {
  color: var(--text-secondary);
  margin-bottom: 2rem;
}

.quiz-question {
  margin-bottom: 2rem;
}

.question-text {
  font-size: 1.1rem;
  margin-bottom: 1rem;
}

.question-answers {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.answer-option {
  display: flex;
  align-items: center;
  padding: 1rem;
  background: rgba(139, 92, 246, 0.05);
  border: 2px solid transparent;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s;
  position: relative;
}

.answer-option:hover {
  background: rgba(139, 92, 246, 0.1);
  border-color: var(--primary);
}

.answer-option input[type="radio"] {
  margin-right: 0.75rem;
}

.answer-option.correct {
  border-color: var(--success);
  background: rgba(16, 185, 129, 0.1);
}

.answer-option.incorrect {
  border-color: var(--danger);
  background: rgba(239, 68, 68, 0.1);
}

.question-feedback {
  margin-top: 1rem;
  padding: 1rem;
  border-radius: 8px;
  background: rgba(139, 92, 246, 0.1);
}

.quiz-actions {
  margin-top: 2rem;
}

.quiz-results {
  text-align: center;
  padding: 2rem;
}

.results-score {
  font-size: 3rem;
  font-weight: bold;
  background: linear-gradient(135deg, var(--primary), var(--accent));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin: 1rem 0;
}

/* Lesson actions */
.lesson-actions {
  display: flex;
  gap: 1rem;
  margin-top: 3rem;
  flex-wrap: wrap;
}

.completion-message {
  text-align: center;
  padding: 2rem;
  background: rgba(139, 92, 246, 0.1);
  border-radius: 12px;
  width: 100%;
}

.completion-message h3 {
  font-size: 1.5rem;
  margin-bottom: 0.5rem;
}

/* Responsive */
@media (max-width: 1024px) {
  .learn-sidebar {
    width: 300px;
  }
}

@media (max-width: 768px) {
  .learn-container {
    flex-direction: column;
  }

  .learn-sidebar {
    width: 100%;
    height: auto;
    position: relative;
    top: 0;
  }

  .learn-content {
    padding: 2rem 1rem;
  }

  .lesson-title {
    font-size: 2rem;
  }
}
</style>
{% endblock %}
