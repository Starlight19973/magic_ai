services:
  # Основное приложение Нейромагии
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: neuromagic-app
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      # База данных (персистентность)
      - ./data:/app/data
      # Логи
      - ./logs:/app/logs
    environment:
      # Основные настройки
      - SECRET_KEY=${SECRET_KEY:-change-this-in-production}
      - APP_ENV=${APP_ENV:-production}

      # База данных (SQLite в volume)
      - DATABASE_URL=sqlite+aiosqlite:///data/neuromagic.db

      # Telegram OAuth (для авторизации)
      - TELEGRAM_OAUTH_BOT_TOKEN=${TELEGRAM_OAUTH_BOT_TOKEN}
      - TELEGRAM_OAUTH_BOT_USERNAME=${TELEGRAM_OAUTH_BOT_USERNAME}

      # Telegram notifications (для отправки заявок в группу)
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID:-}

      # SMTP для email верификации
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - SMTP_FROM_EMAIL=${SMTP_FROM_EMAIL}
      - SMTP_FROM_NAME=${SMTP_FROM_NAME:-Нейромагия}

      # Контакты
      - CONTACT_EMAIL=${CONTACT_EMAIL:-hello@neuro-magic.ru}
      - SITE_NAME=${SITE_NAME:-Нейромагия}
    networks:
      - neuromagic-network
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000').read()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      # Метки для мониторинга
      - "com.neuromagic.app=main"
      - "com.neuromagic.version=1.0"

  # Nginx reverse proxy (опционально, для production)
  nginx:
    image: nginx:alpine
    container_name: neuromagic-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./static:/app/static:ro
    depends_on:
      - app
    networks:
      - neuromagic-network
    profiles:
      - production

networks:
  neuromagic-network:
    driver: bridge

volumes:
  # Volumes для персистентности
  app-data:
    driver: local

